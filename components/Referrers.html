<details on:toggle='update(event)'>
  <summary></summary>
  {{ #if referrers.length }}
    {{ #each referrers as referrer }}
      <div class='referrer'>
        <code>{{ format(referrer.percentage) }}</code>
        <a href='{{ referrer.url }}'>{{ referrer.host }}</a>
      </div>
    {{ /each }}
  {{ else }}
    Loadingâ€¦
  {{ /if }}
</details>

<style>
  details {
    line-height: 1.4em;
  }

  code {
    margin-right: 0.5em;
    color: gray;
    font-size: 0.7em;
    white-space: pre;
  }

  summary {
    outline: none;
  }

  .referrer {
    white-space: nowrap;
  }
</style>

<script>
  import { URLS } from '../src/settings';

  let loaded = false;

  export default {
    data() {
      return {
        referrers: []
      }
    },

    helpers: {
      format: float => {
        if (float < 0.01) return '< 0.01';
        return float.toFixed(2).padStart(6)
      }
    },

    methods: {
      update(event) {
        if (event.target.open && !loaded) this.load();
      },

      async load() {
        const data = await fetch(URLS.ferris).then(res => res.json());

        const hosts = data.reduce((accu, item) => {
          if (item.url.startsWith('http') && !item.url.startsWith(URLS.base)) {
            const url = item.url.replace(/^([^.]*)www\./, '$1');
            const host = url.split('/')[2];

            let data = accu.get(host);

            if (!data) {
              data = { host, url, hits: item.hits, total: 0 };
              accu.set(host, data);
            } else if (item.hits > data.hits) {
              data.url = item.url;
              data.hits = item.hits;
            }

            data.total += item.hits;
            return accu;
          }
        }, new Map());

        const values = hosts.values();

        let referrers = Array.from(values);
        const total = referrers.reduce((accu, item) => accu += item.total, 0);

        referrers.sort((a, b) => b.hits - a.hits);
        referrers = referrers.map(item => {
          item.percentage = item.total / total * 100;
          return item;
        });

        this.set({ referrers });
        loaded = true;
      }
    }
  }
</script>
